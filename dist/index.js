/* yocto-mailchimp - Manage mailchimp client - V0.1.0 */
"use strict";function Mailchimp(a){this.logger=a,this.config={},this.modules={"v2.0":require("./modules/v2.0.js")(a)}}var _=require("lodash"),logger=require("yocto-logger"),utils=require("yocto-utils"),joi=require("joi"),Q=require("q");Mailchimp.prototype.loadConfig=function(a){var b=Q.defer(),c=joi.array().min(1).items(joi.object().required().keys({version:joi.string().required().allow(["v2.0"]),name:joi.string().required().empty(),token:joi.string().required().empty(),list:joi.array().items(joi.object({name:joi.string().required().empty(),id:joi.string().required().empty(),doubleOptin:joi["boolean"]().optional()["default"](!0)}).required()).required().min(1)})),d=joi.validate(a,c);return d.error?(b.reject("The joi validation failed, more details : "+d.error.toString()),b.promise):(this.config.setting=d.value,this.logger.info("[ Mailchimp.loadConfig ] - config load success"),b.resolve(!0),b.promise)},Mailchimp.prototype.subscribe=function(a){var b=Q.defer(),c=joi.object().required().keys({accountName:joi.string().required().empty(),listName:joi.string().required().empty(),email:joi.string().email().required().empty()}),d=c.validate(a);if(d.error)return b.reject("The required params are not present, more details : "+utils.obj.inspect(d.error)),b.promise;var e=_.find(this.config.setting,{name:a.accountName});if(_.isUndefined(e))return this.logger.error("[ Mailchimp.subscribe ] - Unknow config for the account name : "+a.accountName),b.reject("Unknow config for the account name : "+a.accountName),b.promise;var f=_.find(e.list,{name:a.listName});return _.isUndefined(f)?(this.logger.error("[ Mailchimp.subscribe ] - Unknow config for the account list name : "+a.accountName+" of account : "+a.listName),b.reject("Unknow config for the account list name : "+a.accountName+" of account : "+a.listName),b.promise):this.modules[e.version].subscribe(e,f,a.email)},module.exports=function(a){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ Yocto-Mailchimp.constructor ] - Invalid logger given. Use internal logger"),a=logger),new Mailchimp(a)};